<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLAPPY FINAL FORM</title>
<style>
body {margin:0;overflow:hidden;background:black;font-family:Arial;color:white;}
canvas {display:block;margin:auto;}
#menu {position:absolute;width:100%;text-align:center;top:15%;}
button {padding:12px 20px;margin:6px;border:none;border-radius:8px;background:#ffcc00;font-weight:bold;cursor:pointer;}
h1 {font-size:40px;}
</style>
</head>
<body>

<div id="menu">
<h1 id="title">üê§ FLAPPY FINAL FORM</h1>
<button onclick="startGame()">PLAY</button>
<p>High Score: <span id="hs"></span></p>
<p id="devilText"></p>
</div>

<canvas id="game"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

let gravity=0.5,lift=-10;
let bird,pipes,score,frame,running=false;
let speed=3;
let highScore=+localStorage.getItem("hs")||0;
let ghost=JSON.parse(localStorage.getItem("ghost"))||[];
let replay=[];
let devilMode=false;
let particles=[];

document.getElementById("hs").innerText=highScore;

/* ---- SECRET DEVIL MODE ---- */
if (performance.navigation.type === 1) {
    devilMode=true;
    document.getElementById("devilText").innerText="üòà DEVIL MODE ACTIVATED";
}
/* --------------------------- */

function startGame(){
    document.getElementById("menu").style.display="none";
    running=true;
    bird={x:100,y:canvas.height/2,r:20,v:0};
    pipes=[];
    score=0;
    frame=0;
    replay=[];
    loop();
}

function endGame(){
    if(devilMode) return; // UNKILLABLE
    running=false;
    if(score>highScore){
        highScore=score;
        localStorage.setItem("hs",highScore);
        localStorage.setItem("ghost",JSON.stringify(replay));
    }
    document.getElementById("hs").innerText=highScore;
    document.getElementById("menu").style.display="block";
}

function createPipe(){
    let gap=160;
    let top=Math.random()*(canvas.height-gap-200)+50;
    pipes.push({x:canvas.width,w:80,top:top,bottom:top+gap,passed:false});
}

function update(){
    bird.v+=gravity;
    bird.y+=bird.v;

    if(frame%80===0) createPipe();

    pipes.forEach(p=>{
        p.x-=speed+(score*0.02);

        if(!p.passed&&p.x+p.w<bird.x){
            p.passed=true;
            score+= devilMode?2:1;
            spawnParticles(bird.x,bird.y);
        }

        if(
            bird.x+bird.r>p.x &&
            bird.x-bird.r<p.x+p.w &&
            (bird.y-bird.r<p.top || bird.y+bird.r>p.bottom)
        ){
            endGame();
        }
    });

    if(bird.y+bird.r>canvas.height||bird.y-bird.r<0) endGame();

    pipes=pipes.filter(p=>p.x+p.w>0);
    replay.push({x:bird.x,y:bird.y});
}

function drawBird(){
    ctx.save();
    ctx.translate(bird.x,bird.y);
    ctx.rotate(bird.v*0.05);

    ctx.fillStyle=devilMode?"red":"yellow";
    ctx.beginPath();
    ctx.arc(0,0,bird.r,0,Math.PI*2);
    ctx.fill();

    if(devilMode){
        ctx.shadowColor="red";
        ctx.shadowBlur=20;
    }

    ctx.restore();
}

function drawPipes(){
    ctx.fillStyle=devilMode?"darkred":"green";
    pipes.forEach(p=>{
        ctx.fillRect(p.x,0,p.w,p.top);
        ctx.fillRect(p.x,p.bottom,p.w,canvas.height);
    });
}

function drawGhost(){
    if(ghost[frame]){
        ctx.fillStyle="rgba(255,255,255,0.3)";
        ctx.beginPath();
        ctx.arc(ghost[frame].x,ghost[frame].y,20,0,Math.PI*2);
        ctx.fill();
    }
}

function spawnParticles(x,y){
    for(let i=0;i<10;i++){
        particles.push({
            x:x,
            y:y,
            vx:(Math.random()-0.5)*4,
            vy:(Math.random()-0.5)*4,
            life:30
        });
    }
}

function drawParticles(){
    particles.forEach(p=>{
        ctx.fillStyle=devilMode?"red":"white";
        ctx.fillRect(p.x,p.y,4,4);
        p.x+=p.vx;
        p.y+=p.vy;
        p.life--;
    });
    particles=particles.filter(p=>p.life>0);
}

function drawBoss(){
    if(score>20){
        ctx.fillStyle=devilMode?"red":"purple";
        ctx.fillRect(canvas.width-200,canvas.height/2-100,100,200);
    }
}

function loop(){
    if(!running) return;

    ctx.fillStyle=devilMode?"black":"#70c5ce";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    update();
    drawGhost();
    drawBird();
    drawPipes();
    drawParticles();
    drawBoss();

    ctx.fillStyle=devilMode?"red":"white";
    ctx.font="30px Arial";
    ctx.fillText("Score: "+score,20,50);

    frame++;
    requestAnimationFrame(loop);
}

function flap(){ if(running) bird.v=lift; }
document.addEventListener("keydown",e=>{if(e.code==="Space") flap();});
document.addEventListener("click",flap);
document.addEventListener("touchstart",flap);

/* Background Music */
let audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let osc=audioCtx.createOscillator();
osc.type="sawtooth";
osc.frequency.value=devilMode?120:220;
osc.connect(audioCtx.destination);
osc.start();
osc.stop(audioCtx.currentTime+0.1);

</script>
</body>
</html>
